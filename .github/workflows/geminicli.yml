name: Gemini CLI
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  gemini-cli:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # Debug Step: Runs FIRST to verify the key
      - name: Debug API Key (Curl)
        env:
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          curl -H "Content-Type: application/json" \
          -d '{ "contents": [{"parts":[{"text": "Hello"}]}] }' \
          "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=$API_KEY"
      # Main Action (Manual Curl)
      - name: Call Gemini API
        id: gemini
        env:
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PROMPT: ${{ github.event.comment.body }}
        run: |
          # Create JSON payload securely
          jq -n \
            --arg text "$PROMPT" \
            '{contents: [{parts: [{text: $text}]}]}' > payload.json
          
          # Call API
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=$API_KEY")
          
          # Extract text using jq
          OUTPUT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Error: No response text found"')
          
          # Set output
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.issue.number }}
          RESPONSE: ${{ steps.gemini.outputs.output }}
        run: |
          gh pr comment "$PR_NUMBER" --body "$RESPONSE"
