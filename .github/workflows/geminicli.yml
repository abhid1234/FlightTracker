name: Gemini CLI
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  gemini-cli:
    # Run if the comment contains @gemini-cli
    if: contains(github.event.comment.body, '@gemini-cli')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Call Gemini API
        id: gemini
        env:
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PROMPT: ${{ github.event.comment.body }}
        run: |
          # Clean prompt (remove @gemini-cli prefix)
          CLEAN_PROMPT=$(echo "$PROMPT" | sed 's/@gemini-cli//g' | xargs)
          
          # Create JSON payload
          jq -n --arg text "$CLEAN_PROMPT" '{contents: [{parts: [{text: $text}]}]}' > payload.json
          
          # Call API and capture response (Using 2.5 Flash for faster response)
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$API_KEY")
          
          echo "API Response: $RESPONSE"
          
          # Extract text using jq with more robust path
          # Fallback to error message if candidates are missing
          OUTPUT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // .error.message // "Error: Gemini API returned an unexpected response format."')
          
          # Handle multi-line output for GITHUB_OUTPUT
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Dynamically get PR number depending on the event type
          PR_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
          RESPONSE: ${{ steps.gemini.outputs.output }}
        run: |
          gh pr comment "$PR_NUMBER" --body "ðŸ¤– **Gemini CLI Response:**

          $RESPONSE"
